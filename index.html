<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COUNTER • Ticket Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap');

        :root { --primary: #1e40af; }

        body { font-family: 'Inter', system-ui, sans-serif; }

        .logo-font { font-family: 'Playfair Display', serif; }

        .ticket {
            width: 80mm;
            height: 48mm;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            border: 2.5px solid #1e40af;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            page-break-inside: avoid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .ticket::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 14px;
            background: repeating-linear-gradient(45deg, #1e40af, #1e40af 8px, #f1f5f9 8px, #f1f5f9 16px);
        }

        .ticket-cut {
            border-top: 1.5px dashed #64748b;
            margin-top: 6px;
            padding-top: 6px;
        }

        .qr-container { width: 56px; height: 56px; }

        @media print {
            body * { visibility: hidden !important; }
            #printable, #printable * { visibility: visible !important; }
            #printable {
                position: absolute !important;
                inset: 0 !important;
                width: 100% !important;
                min-height: 100vh !important;
                background: white !important;
                padding: 10mm !important;
                box-sizing: border-box !important;
            }
            .ticket {
                box-shadow: none !important;
                border: 1px solid #000 !important;
                margin: 5mm 3mm !important;
                width: 80mm !important;
                height: 48mm !important;
            }
            #tickets-container {
                display: grid !important;
                grid-template-columns: repeat(3, 80mm) !important;
                gap: 10mm 12mm !important;
                justify-content: center !important;
                max-width: 210mm !important;
                margin: 0 auto !important;
            }
            #print-header { margin-bottom: 8mm !important; }
            .print\\:hidden { display: none !important; }
        }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-200 min-h-screen">

    <!-- Your existing sidebar + preview layout remains the same -->
    <!-- ... (copy your sidebar, top bar, preview area, status bar here - unchanged) ... -->

    <!-- PRINTABLE AREA – improved -->
    <div id="printable" class="hidden bg-white overflow-auto p-8" style="position:absolute; left:0; top:0; width:100%; z-index:9999;">
        <div id="print-header" class="max-w-[210mm] mx-auto mb-8 flex justify-between items-center border-b pb-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center text-4xl font-black logo-font">T</div>
                <div>
                    <div class="text-3xl font-bold text-zinc-900 logo-font">xAI India Summit 2026</div>
                    <div class="text-zinc-600">Official Entry Tickets</div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-4xl font-bold text-blue-600" id="print-total">₹0</div>
                <div class="text-xs text-zinc-500">TOTAL COLLECTED</div>
            </div>
        </div>

        <div id="tickets-container" class="max-w-[210mm] mx-auto grid grid-cols-3 gap-x-12 gap-y-8">
            <!-- tickets go here -->
        </div>

        <div class="text-center text-zinc-400 text-xs mt-12 print:hidden">
            Printed on <span id="print-date"></span> • For internal use only
        </div>
    </div>

    <script>
        // ... (keep your existing variables, initTypeButtons, initQtyButtons, calculateSummary, generateTicketHTML unchanged)

        // Improved QR creation with callback
        function createQR(elementId, data, callback = () => {}) {
            const container = document.getElementById(elementId);
            if (!container) return callback();
            container.innerHTML = "";
            new QRCode(container, {
                text: data,
                width: 56,
                height: 56,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            setTimeout(callback, 300); // give time to render
        }

        // In generateTickets() – after pushing all tickets
        // Render preview as before...

        function renderPrintable(callback = () => {}) {
            const container = document.getElementById("tickets-container");
            container.innerHTML = "";
            let rendered = 0;

            generatedTickets.forEach((t, index) => {
                const wrapper = document.createElement("div");
                wrapper.innerHTML = generateTicketHTML(t, false);
                container.appendChild(wrapper.firstElementChild);

                createQR(`qr-${t.id}`, t.qrData, () => {
                    rendered++;
                    if (rendered === generatedTickets.length) {
                        document.getElementById("print-date").textContent = new Date().toLocaleDateString('en-IN');
                        document.getElementById("print-total").textContent = `₹${generatedTickets.reduce((s, t) => s + t.finalPrice, 0).toLocaleString('en-IN')}`;
                        callback();
                    }
                });
            });
        }

        function printTickets() {
            if (!generatedTickets.length) return alert("Generate tickets first!");

            const printable = document.getElementById("printable");
            printable.classList.remove("hidden");

            renderPrintable(() => {
                setTimeout(() => {
                    window.focus();
                    window.print();
                    setTimeout(() => {
                        printable.classList.add("hidden");
                    }, 1500);
                }, 800); // extra time for layout
            });
        }

        function downloadPDF() {
            if (!generatedTickets.length) return alert("No tickets to export!");

            if (generatedTickets.length > 12) {
                if (!confirm("Large quantity (PDF may be blank due to browser limits). Continue anyway?")) return;
            }

            const printable = document.getElementById("printable");
            printable.classList.remove("hidden");

            renderPrintable(() => {
                setTimeout(() => {
                    const opt = {
                        margin: [8, 8, 8, 8],
                        filename: `tickets_${new Date().toISOString().slice(0,10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: { 
                            scale: 2.2, 
                            useCORS: true, 
                            logging: false,
                            windowWidth: 794,   // A4 at 96dpi ≈ 794px
                            windowHeight: 1123
                        },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    html2pdf().set(opt).from(printable).save().then(() => {
                        printable.classList.add("hidden");
                    }).catch(err => {
                        console.error(err);
                        alert("PDF generation failed – try PRINT → Save as PDF instead.");
                        printable.classList.add("hidden");
                    });
                }, 1200);
            });
        }

        // ... (rest of your script: clearAll, event listeners, onload)
    </script>
</body>
</html>
