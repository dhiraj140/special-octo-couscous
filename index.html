<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Ticket Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter&family=Playfair+Display&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .logo-font {
            font-family: 'Playfair Display', serif;
        }
        @media print {
            @page {
                size: A4 landscape;
                margin: 5mm;
            }
            body > * {
                display: none !important;
            }
            #printable {
                display: grid !important;
                grid-template-columns: repeat(3, 80mm);
                grid-auto-rows: 48mm;
                gap: 6mm;
                position: static !important;
                left: 0 !important;
            }
            .ticket {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-200 min-h-screen flex">
    <aside class="w-96 p-6 border-r border-zinc-800 flex flex-col gap-4">
        <h1 class="logo-font text-3xl mb-4">Event Ticket Generator</h1>
        
        <!-- Event Details -->
        <div>
            <label class="block text-sm mb-1">Event Name</label>
            <input id="eventName" class="w-full bg-zinc-800 text-zinc-200 p-2 rounded" value="Sample Event">
        </div>
        <div>
            <label class="block text-sm mb-1">Event Date</label>
            <input id="eventDate" type="date" class="w-full bg-zinc-800 text-zinc-200 p-2 rounded">
        </div>
        <div>
            <label class="block text-sm mb-1">Venue</label>
            <input id="venue" class="w-full bg-zinc-800 text-zinc-200 p-2 rounded" value="Sample Venue">
        </div>
        
        <!-- Ticket Type -->
        <div>
            <label class="block text-sm mb-1">Ticket Type</label>
            <select id="ticketType" class="w-full bg-zinc-800 text-zinc-200 p-2 rounded">
                <option value="PRIME" data-price="15000">PRIME - ₹15,000</option>
                <option value="PLUS" data-price="11000">PLUS - ₹11,000</option>
                <option value="ECONO" data-price="2500">ECONO - ₹2,500</option>
            </select>
        </div>
        
        <!-- Quantity -->
        <div>
            <label class="block text-sm mb-1">Quantity</label>
            <select id="quantity" class="w-full bg-zinc-800 text-zinc-200 p-2 rounded">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
            </select>
        </div>
        
        <!-- Discount -->
        <div>
            <label class="block text-sm mb-1">Discount Type</label>
            <select id="discountType" class="w-full bg-zinc-800 text-zinc-200 p-2 rounded">
                <option value="none">No Discount</option>
                <option value="flat">Flat Amount (₹)</option>
                <option value="percent">Percentage (%)</option>
            </select>
        </div>
        <div>
            <label class="block text-sm mb-1">Discount Value</label>
            <input id="discountValue" type="number" min="0" class="w-full bg-zinc-800 text-zinc-200 p-2 rounded" disabled>
        </div>
        
        <!-- Live Summary -->
        <div class="bg-zinc-900 p-4 rounded">
            <h2 class="text-lg mb-2">Summary</h2>
            <p>Ticket Type: <span id="sumType" class="font-bold"></span> <span class="ml-2 px-2 py-1 bg-blue-600 text-xs rounded">Badge</span></p>
            <p>Base Price: ₹<span id="sumPrice"></span></p>
            <p>Quantity: <span id="sumQty"></span></p>
            <p>Subtotal: ₹<span id="sumSub"></span></p>
            <p>Discount: ₹<span id="sumDisc"></span></p>
            <p class="text-2xl text-emerald-400">Final: ₹<span id="sumFinal"></span></p>
        </div>
        
        <!-- Buttons -->
        <button id="generate" class="bg-blue-600 text-white p-2 rounded flex items-center justify-center gap-2"><i class="fas fa-ticket-alt"></i> Generate Preview</button>
        <button id="printBtn" class="bg-emerald-600 text-white p-2 rounded flex items-center justify-center gap-2"><i class="fas fa-print"></i> Print</button>
        <button id="pdfBtn" class="bg-purple-600 text-white p-2 rounded flex items-center justify-center gap-2"><i class="fas fa-file-pdf"></i> PDF</button>
        <button id="clear" class="bg-red-600 text-white p-2 rounded flex items-center justify-center gap-2"><i class="fas fa-trash"></i> Clear Session</button>
    </aside>
    
    <main class="flex-1 p-6">
        <h2 class="text-2xl mb-4">Ticket Preview</h2>
        <div id="preview" class="grid grid-cols-4 gap-4"></div>
    </main>
    
    <div id="printable" class="absolute left-[-9999px] grid grid-template-columns: repeat(3, 80mm) gap-6mm"></div>
    
    <script>
        // Initialize defaults
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('eventDate').value = today;
            updateSummary();
            generateTickets(); // Demo 1 ticket
        });

        // Get elements
        const inputs = ['ticketType', 'quantity', 'discountType', 'discountValue', 'eventName', 'eventDate', 'venue'];
        inputs.forEach(id => document.getElementById(id).addEventListener('change', updateSummary));

        document.getElementById('discountType').addEventListener('change', () => {
            const type = document.getElementById('discountType').value;
            const valueInput = document.getElementById('discountValue');
            valueInput.disabled = type === 'none';
            if (type === 'none') valueInput.value = '';
        });

        document.getElementById('generate').addEventListener('click', generateTickets);
        document.getElementById('printBtn').addEventListener('click', printTickets);
        document.getElementById('pdfBtn').addEventListener('click', pdfTickets);
        document.getElementById('clear').addEventListener('click', () => {
            localStorage.clear();
            alert('Session cleared');
            location.reload();
        });

        // Update live summary
        function updateSummary() {
            const typeSelect = document.getElementById('ticketType');
            const type = typeSelect.value;
            const basePrice = parseInt(typeSelect.options[typeSelect.selectedIndex].dataset.price);
            const qty = parseInt(document.getElementById('quantity').value);
            const discType = document.getElementById('discountType').value;
            const discValue = parseFloat(document.getElementById('discountValue').value) || 0;

            const subtotal = basePrice * qty;
            let discountAmt = 0;
            if (discType === 'flat') discountAmt = discValue;
            else if (discType === 'percent') discountAmt = subtotal * (discValue / 100);
            const finalTotal = subtotal - discountAmt;

            document.getElementById('sumType').textContent = type;
            document.getElementById('sumPrice').textContent = basePrice.toLocaleString();
            document.getElementById('sumQty').textContent = qty;
            document.getElementById('sumSub').textContent = subtotal.toLocaleString();
            document.getElementById('sumDisc').textContent = discountAmt.toLocaleString();
            document.getElementById('sumFinal').textContent = finalTotal.toLocaleString();
        }

        // Generate tickets
        function generateTickets() {
            updateSummary();
            const preview = document.getElementById('preview');
            const printable = document.getElementById('printable');
            preview.innerHTML = '';
            printable.innerHTML = '';

            const typeSelect = document.getElementById('ticketType');
            const type = typeSelect.value;
            const basePrice = parseInt(typeSelect.options[typeSelect.selectedIndex].dataset.price);
            const qty = parseInt(document.getElementById('quantity').value);
            const discType = document.getElementById('discountType').value;
            const discValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const eventName = document.getElementById('eventName').value;
            const venue = document.getElementById('venue').value;
            const eventDateInput = document.getElementById('eventDate').value;
            const eventDate = new Date(eventDateInput).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

            const subtotal = basePrice * qty;
            let discountAmt = 0;
            if (discType === 'flat') discountAmt = discValue;
            else if (discType === 'percent') discountAmt = subtotal * (discValue / 100);
            const finalTotal = subtotal - discountAmt;
            const finalPerTicket = finalTotal / qty;

            // Get or init sequential number
            let nextSeq = parseInt(localStorage.getItem('nextSeq')) || 1;
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');

            for (let i = 1; i <= qty; i++) {
                const ticketId = `TCK${dateStr}-${String(nextSeq++).padStart(4, '0')}`;
                const serial = `${i}/${qty}`;
                const timeIso = new Date().toISOString();
                const qrContent = `EVENT=${eventName}|TYPE=${type}|ID=${ticketId}|PRICE=${Math.round(finalPerTicket)}|TIME=${timeIso}|QTY=${qty}|SERIAL=${serial}`;

                // Create ticket HTML
                const ticketHTML = `
                    <div class="ticket w-[80mm] h-[48mm] border border-blue-500 bg-gradient-to-b from-zinc-100 to-blue-50 text-black p-2 flex flex-col justify-between relative overflow-hidden">
                        <div class="top flex justify-between items-start">
                            <span class="text-xs">${eventName}</span>
                            <span class="font-bold text-lg">${type}</span>
                            <span class="text-2xl font-bold text-blue-600">₹${Math.round(finalPerTicket).toLocaleString()}</span>
                        </div>
                        <div class="middle text-center text-sm">
                            ${venue} • ${eventDate}
                        </div>
                        <hr class="border-t border-dashed border-black my-1">
                        <div class="bottom flex justify-between items-center">
                            <span class="text-xs">${ticketId}</span>
                            <span class="font-bold text-xl text-center flex-1">${serial}</span>
                            <div id="qr-${i}" class="w-[56px] h-[56px]"></div>
                        </div>
                        <div class="absolute bottom-0 left-0 w-full h-[5mm] bg-red-500 text-white text-xs font-bold text-center flex items-center justify-center">
                            SINGLE ENTRY ONLY • DUPLICATES REJECTED
                        </div>
                    </div>
                `;

                // For preview (scaled)
                const previewWrapper = document.createElement('div');
                previewWrapper.classList.add('transform', 'scale-75', 'origin-top-left');
                previewWrapper.innerHTML = ticketHTML.replace(`id="qr-${i}"`, `id="qr-prev-${i}"`);
                preview.appendChild(previewWrapper);

                // For printable
                const printTicket = document.createElement('div');
                printTicket.innerHTML = ticketHTML;
                printable.appendChild(printTicket);

                // Generate QR for preview
                new QRCode(document.getElementById(`qr-prev-${i}`), {
                    text: qrContent,
                    width: 56,
                    height: 56,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Generate QR for print
                new QRCode(document.getElementById(`qr-${i}`), {
                    text: qrContent,
                    width: 56,
                    height: 56,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            // Save nextSeq
            localStorage.setItem('nextSeq', nextSeq);
        }

        // Print function
        function printTickets() {
            generateTickets(); // Ensure latest
            document.getElementById('printable').style.display = 'block';
            window.print();
            document.getElementById('printable').style.display = 'none';
        }

        // PDF function
        function pdfTickets() {
            const qty = parseInt(document.getElementById('quantity').value);
            if (qty > 12) {
                if (!confirm('For quantities >12, PDF may be blank due to canvas limits. Proceed? If blank, use Print > Save as PDF instead.')) return;
            }
            generateTickets(); // Ensure latest
            const element = document.getElementById('printable');
            element.style.display = 'block';
            const opt = {
                margin: 5,
                filename: 'tickets.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2.2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().from(element).set(opt).save().then(() => {
                element.style.display = 'none';
            });
        }
    </script>
</body>
</html>
